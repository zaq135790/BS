<!--pages/puzzle/puzzle.wxml-->
<view class="container">
  <!-- 加载中 -->
  <view wx:if="{{loading}}" class="loading">
    <text>加载中...</text>
  </view>

  <!-- 游戏开始前 -->
  <view wx:elif="{{!gameStarted && !gameEnded}}" class="start-screen">
    <image class="start-bg" src="{{startBackground}}" mode="aspectFill"></image>
    <view class="start-overlay"></view>
    <view class="start-content">
    <view class="title">虫虫拼图</view>
    <view class="subtitle">将昆虫拼图完整拼好</view>
    
    <!-- 难度选择 -->
    <view class="difficulty-selector">
      <text class="label">选择难度:</text>
      <view class="difficulty-options">
        <button 
          class="difficulty-btn {{difficulty === '简单' ? 'active' : ''}}"
          bindtap="selectDifficulty"
          data-difficulty="简单"
        >
          简单 (2x2)
        </button>
        <button 
          class="difficulty-btn {{difficulty === '困难' ? 'active' : ''}}"
          bindtap="selectDifficulty"
          data-difficulty="困难"
        >
          困难 (3x3)
        </button>
      </view>
    </view>

    <button class="start-btn" bindtap="startGame">开始拼图</button>
    </view>
  </view>

  <!-- 游戏进行中 -->
  <view wx:elif="{{gameStarted && !gameEnded}}" class="game-screen">
    <!-- 游戏信息 -->
    <view class="game-info">
      <view class="timer">用时: {{formattedTime}}</view>
      <view class="progress">进度: {{completedPieces.length}}/{{puzzleConfig.pieces_count}}</view>
      <button class="hint-btn" bindtap="toggleHint">提示</button>
    </view>

    <!-- 拼图区域：上方空白待放区 -->
    <view class="puzzle-area">
      <view class="puzzle-grid" style="grid-template-columns: repeat({{gridSize}}, 1fr);">
        <view 
          wx:for="{{slots}}" 
          wx:key="index"
          class="puzzle-piece {{item && item.completed ? 'completed' : ''}}"
          bindtap="handleSlotTap"
          data-index="{{index}}"
          style="{{item && item.bgStyle ? item.bgStyle : ''}}"
        >
          <view wx:if="{{item && item.completed}}" class="piece-placeholder">✓</view>
        </view>
      </view>
    </view>

    <!-- 拼图区：下方可拖放/点击的拼图块 -->
    <view class="tray-area">
      <view class="tray-grid" style="grid-template-columns: repeat({{gridSize}}, 1fr);">
        <view 
          wx:for="{{trayPieces}}" 
          wx:key="id"
          class="tray-piece {{selectedPieceId === item.id ? 'selected' : ''}}"
          bindtap="clickPiece"
          data-id="{{item.id}}"
          style="{{item.bgStyle}}"
        ></view>
      </view>
      <view class="tray-hint">点击拼图块，再点击上方对应位置完成拼图</view>
    </view>

    <!-- 提示：显示完整图片，大图点击关闭 -->
    <view wx:if="{{showHint}}" class="hint-overlay" bindtap="toggleHint">
      <image class="hint-image" src="{{fullImageUrl}}" mode="widthFix"></image>
      <view class="hint-tip">轻触任意位置关闭提示，继续拼图</view>
    </view>
  </view>

  <!-- 游戏结束 -->
  <view wx:elif="{{gameEnded}}" class="end-screen">
    <view class="title">拼图完成！</view>
    <view class="final-score">用时: {{formattedTime}}</view>
    <view class="final-score">得分: {{score}}</view>
    <view class="buttons">
      <button class="btn" bindtap="restartGame">再来一局</button>
      <button class="btn secondary" bindtap="goBack">返回</button>
    </view>
  </view>
</view>

