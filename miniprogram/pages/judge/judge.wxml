<!--pages/judge/judge.wxml-->
<view class="container">
  <!-- åŠ è½½ä¸­ -->
  <view wx:if="{{loading}}" class="loading">
    <text>åŠ è½½ä¸­...</text>
  </view>

  <!-- æ¸¸æˆå¼€å§‹å‰ -->
  <view wx:elif="{{!gameStarted && !gameEnded}}" class="start-screen">
    <image class="start-bg" src="{{startBackground}}" mode="aspectFill"></image>
    <view class="start-overlay"></view>
    <view class="start-content">
      <view class="title-spacer"></view>
      <view class="start-actions">
        <button class="start-btn" bindtap="startGame">å¼€å§‹æ¸¸æˆ</button>
        <button class="exit-btn" bindtap="goBack">é€€å‡ºæ¸¸æˆ</button>
      </view>
    </view>
  </view>

  <!-- æ¸¸æˆè¿›è¡Œä¸­ -->
  <view wx:elif="{{gameStarted && !gameEnded}}" class="game-screen">
    <!-- è¿›åº¦æ¡ -->
    <view class="progress">
      <view class="progress-bar">
        <view class="progress-fill" style="width: {{progressPercent}}%"></view>
      </view>
      <text class="progress-text">ç¬¬ {{currentQuestionIndex + 1}} é¢˜ - {{currentStep === 1 ? 'çŒœåå­—' : 'åˆ¤æ–­ç›Šå®³'}}</text>
    </view>

    <!-- ç¬¬ä¸€æ­¥ï¼šçŒœåå­— -->
    <view wx:if="{{currentStep === 1}}" class="step-container">
      <!-- æç¤ºæŒ‰é’® -->
      <view class="hint-btn" bindtap="onHintClick">
        <text class="hint-icon">ğŸ’¡</text>
      </view>
      
      <!-- æ˜†è™«å›¾ç‰‡ -->
      <view class="insect-display">
        <image class="insect-image" src="{{currentInsect.image}}" mode="aspectFit"></image>
      </view>
      
      <!-- å£è¯€ -->
      <view class="rhyme-section">
        <text class="rhyme-label">å£è¯€ï¼š</text>
        <text class="rhyme-text">{{currentInsect.rhyme}}</text>
      </view>
      
      <!-- åå­—é€‰é¡¹ï¼ˆ3é€‰1ï¼‰ -->
      <view class="name-options">
        <block wx:for="{{nameOptions}}" wx:key="name">
          <button
            class="name-option-btn {{selectedName === item ? 'selected' : ''}} {{showResult && !isCorrect && selectedName === item ? 'wrong' : ''}} {{showResult && showCorrectAnswer && currentInsect.name === item ? 'correct' : ''}}"
            bindtap="selectNameOption"
            data-answer="{{item}}"
            disabled="{{showResult || usedHint}}"
          >
            {{item}}
          </button>
        </block>
      </view>

      <!-- æäº¤æŒ‰é’® -->
      <view class="input-section">
        <button class="submit-btn" bindtap="submitNameAnswer" disabled="{{showResult || usedHint}}">æäº¤</button>
      </view>

      <!-- æ˜¾ç¤ºç­”æ¡ˆï¼ˆæç¤ºåï¼‰ -->
      <view wx:if="{{showInsectName}}" class="answer-display">
        <text class="answer-text">æ­£ç¡®ç­”æ¡ˆï¼š{{currentInsect.name}}</text>
      </view>
      
      <!-- ç»“æœæ˜¾ç¤º -->
      <view wx:if="{{showResult}}" class="result-display">
        <view class="result-text {{isCorrect ? 'correct' : 'wrong'}}">
          {{isCorrect ? 'å›ç­”æ­£ç¡®ï¼' : 'å›ç­”é”™è¯¯ï¼Œå†æƒ³æƒ³ï¼'}}
        </view>
        <!-- åªåœ¨ç¬¬äºŒæ¬¡é”™è¯¯åæ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆ -->
        <view wx:if="{{!isCorrect && showCorrectAnswer}}" class="correct-answer">
          æ­£ç¡®ç­”æ¡ˆï¼š{{currentInsect.name}}
        </view>
      </view>
    </view>

    <!-- ç¬¬äºŒæ­¥ï¼šåˆ¤æ–­ç›Šå®³ -->
    <view wx:if="{{currentStep === 2}}" class="step-container">
      <!-- æ˜†è™«ä¿¡æ¯ -->
      <view class="insect-info">
        <image class="insect-image-small" src="{{currentInsect.image}}" mode="aspectFit"></image>
        <text class="insect-name">{{currentInsect.name}}</text>
        <text class="insect-rhyme">{{currentInsect.rhyme}}</text>
      </view>
      
      <!-- é—®é¢˜ -->
      <view class="question-section">
        <text class="question-text">è¿™ä¸ªæ˜†è™«æ˜¯ç›Šè™«è¿˜æ˜¯å®³è™«ï¼Ÿ</text>
      </view>
      
      <!-- ç­”æ¡ˆé€‰é¡¹ -->
      <view class="answer-options">
        <button 
          class="answer-btn beneficial {{userAnswer === 'ç›Šè™«' ? 'selected' : ''}} {{showResult && currentInsect.type === 'ç›Šè™«' ? 'correct' : ''}} {{showResult && userAnswer === 'ç›Šè™«' && currentInsect.type !== 'ç›Šè™«' ? 'wrong' : ''}}"
          bindtap="selectAnswer" 
          data-answer="ç›Šè™«"
          disabled="{{showResult}}"
        >
          ç›Šè™«
        </button>
        <button 
          class="answer-btn harmful {{userAnswer === 'å®³è™«' ? 'selected' : ''}} {{showResult && currentInsect.type === 'å®³è™«' ? 'correct' : ''}} {{showResult && userAnswer === 'å®³è™«' && currentInsect.type !== 'å®³è™«' ? 'wrong' : ''}}"
          bindtap="selectAnswer" 
          data-answer="å®³è™«"
          disabled="{{showResult}}"
        >
          å®³è™«
        </button>
      </view>
      
      <!-- ç»“æœæ˜¾ç¤º -->
      <view wx:if="{{showResult}}" class="result-display">
        <view class="result-text {{isCorrect ? 'correct' : 'wrong'}}">
          {{isCorrect ? 'å›ç­”æ­£ç¡®ï¼' : 'å›ç­”é”™è¯¯ï¼'}}
        </view>
        <view class="correct-answer">æ­£ç¡®ç­”æ¡ˆï¼š{{currentInsect.type}}</view>
      </view>
    </view>
  </view>

  <!-- ç»“æŸå¹¶æŸ¥çœ‹æŠ¥å‘Š -->
  <view wx:if="{{gameStarted && !gameEnded}}" class="end-actions">
    <button class="end-btn" bindtap="finishEarly">ç»“æŸå¹¶æŸ¥çœ‹æŠ¥å‘Š</button>
  </view>

  <!-- æ¸¸æˆç»“æŸ -->
  <view wx:elif="{{gameEnded && !showReport}}" class="end-screen">
    <view class="end-title">æ¸¸æˆç»“æŸ</view>
    <view class="end-content">
      <view class="score-display">
        <text class="score-label">å¾—åˆ†</text>
        <text class="score-value">{{score}}/{{totalQuestions}}</text>
      </view>
      <text class="accuracy">æ­£ç¡®ç‡ï¼š{{accuracy}}%</text>
    </view>
    <view class="buttons">
      <button class="btn primary" bindtap="viewReport">æŸ¥çœ‹æŠ¥å‘Š</button>
      <button class="btn secondary" bindtap="restartGame">å†æ¥ä¸€å±€</button>
      <button class="btn secondary" bindtap="goBack">è¿”å›</button>
    </view>
  </view>

  <!-- ç­”é¢˜æŠ¥å‘Š -->
  <view wx:elif="{{showReport}}" class="report-screen">
    <view class="report-header">
      <text class="report-title">ç­”é¢˜æŠ¥å‘Š</text>
      <text class="close-btn" bindtap="closeReport">âœ•</text>
    </view>
    <view class="report-content">
      <view class="report-summary">
        <view class="summary-item">
          <text class="summary-label">æ€»é¢˜æ•°</text>
          <text class="summary-value">{{totalQuestions}}</text>
        </view>
        <view class="summary-item">
          <text class="summary-label">ç­”å¯¹é¢˜æ•°</text>
          <text class="summary-value">{{score}}</text>
        </view>
        <view class="summary-item">
          <text class="summary-label">æ­£ç¡®ç‡</text>
          <text class="summary-value">{{accuracy}}%</text>
        </view>
      </view>
      
      <view class="report-details">
        <text class="details-title">è¯¦ç»†è®°å½•</text>
        <view wx:for="{{answerRecords}}" wx:key="questionIndex" class="detail-item">
          <view class="detail-header">
            <text class="detail-question">ç¬¬ {{item.questionIndex}} é¢˜ï¼š{{item.insectName}}</text>
            <text class="detail-status {{item.typeCorrect ? 'correct' : 'wrong'}}">
              {{item.typeCorrect ? 'âœ“' : 'âœ—'}}
            </text>
          </view>
          <view class="detail-content">
            <view class="detail-step">
              <text class="detail-step-label">ç¬¬ä¸€æ­¥ï¼ˆçŒœåå­—ï¼‰ï¼š</text>
              <text class="detail-step-value {{item.nameCorrect ? 'correct' : 'wrong'}}">
                {{item.nameAnswer}} {{item.nameCorrect ? 'âœ“' : 'âœ—'}}
                <text wx:if="{{item.nameWrongCount >= 2}}" class="wrong-hint">ï¼ˆé”™è¯¯{{item.nameWrongCount}}æ¬¡ï¼‰</text>
              </text>
            </view>
            <view class="detail-step">
              <text class="detail-step-label">ç¬¬äºŒæ­¥ï¼ˆåˆ¤æ–­ç›Šå®³ï¼‰ï¼š</text>
              <text class="detail-step-value {{item.typeCorrect ? 'correct' : 'wrong'}}">
                {{item.typeAnswer}} {{item.typeCorrect ? 'âœ“' : 'âœ—'}}
              </text>
            </view>
          </view>
        </view>
      </view>
    </view>
    <view class="report-buttons">
      <button class="btn primary" bindtap="restartGame">å†æ¥ä¸€å±€</button>
      <button class="btn secondary" bindtap="goBack">è¿”å›</button>
    </view>
  </view>
</view>
