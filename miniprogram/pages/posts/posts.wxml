<!--pages/posts/posts.wxml-->
<view class="container">
  <!-- åˆ·æ–°æç¤º -->
  <view wx:if="{{refreshing}}" class="refresh-indicator">
    <text class="refresh-icon">âŸ³</text>
    <text class="refresh-text">æ­£åœ¨åˆ·æ–°...</text>
  </view>

  <!-- åŠ è½½ä¸­ -->
  <view wx:if="{{loading && !refreshing}}" class="loading">
    <text>åŠ è½½ä¸­...</text>
  </view>

  <!-- å¸–å­åˆ—è¡¨ -->
  <view wx:else class="posts-container">
    <!-- å¸–å­åˆ—è¡¨ -->
    <view class="posts-list">
      <view wx:for="{{posts}}" wx:key="id" class="post-item" bindtap="goToPostDetail" data-id="{{item.id}}">
        <view class="post-header">
          <image class="user-avatar" src="{{item.avatar}}" mode="aspectFill" binderror="onImageError" data-type="avatar"></image>
          <view class="user-info">
            <text class="user-name">{{item.nickname}}</text>
            <text class="post-time">{{item.createTime}}</text>
          </view>
          <view class="post-meta">
            <text class="location">{{item.location}}</text>
            <text class="insect-name">{{item.insectName}}</text>
          </view>
        </view>

        <view class="post-content">
          <text class="content-text">{{item.content}}</text>
        </view>

        <view wx:if="{{item.imageUrl}}" class="post-image">
          <image 
            class="content-image" 
            src="{{item.imageUrl}}" 
            mode="aspectFill" 
            binderror="onImageError" 
            data-type="post"
            catchtap="previewImage"
            data-url="{{item.imageUrl}}"
          ></image>
        </view>

        <view class="post-actions" catchtap="stopPropagation">
          <button 
            class="action-btn {{item.liked ? 'liked' : ''}}" 
            bindtap="likePost" 
            data-id="{{item.id}}"
          >
            <text class="action-icon">{{item.liked ? 'â¤ï¸' : 'ğŸ¤'}}</text>
            <text class="action-text">{{item.likeCount}}</text>
          </button>
        </view>
      </view>
    </view>

    <!-- åŠ è½½æ›´å¤š -->
    <view wx:if="{{hasMore}}" class="load-more">
      <text>ä¸Šæ‹‰åŠ è½½æ›´å¤š</text>
    </view>
    <view wx:else class="no-more">
      <text>æ²¡æœ‰æ›´å¤šäº†</text>
    </view>
  </view>

  <!-- æ‚¬æµ®å‘å¸ƒæŒ‰é’® -->
  <view class="fab-button" bindtap="openPublishModal">
    <text class="fab-icon">+</text>
  </view>

  <!-- å‘å¸ƒå¼¹çª— -->
  <view wx:if="{{showPublishModal}}" class="publish-modal-mask" bindtap="closePublishModal">
    <view class="publish-modal" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">åˆ†äº«ä½ çš„å‘ç°</text>
        <text class="modal-close" bindtap="closePublishModal">Ã—</text>
      </view>

      <view class="modal-content">
        <!-- å›¾ç‰‡é€‰æ‹© -->
        <view class="image-section">
          <view wx:if="{{!imageUrl}}" class="image-placeholder" bindtap="chooseImage">
            <text class="placeholder-icon">ğŸ“·</text>
            <text class="placeholder-text">ç‚¹å‡»æ·»åŠ ç…§ç‰‡</text>
          </view>
          <view wx:else class="image-preview">
            <image class="preview-image" src="{{imageUrl}}" mode="aspectFill"></image>
            <view class="image-actions">
              <button class="action-btn" bindtap="chooseImage">é‡æ–°é€‰æ‹©</button>
            </view>
          </view>
        </view>

        <!-- åœ°ç‚¹è¾“å…¥ -->
        <view class="input-section">
          <text class="input-label">åœ°ç‚¹</text>
          <input 
            class="form-input" 
            placeholder="è¯·è¾“å…¥å‘ç°åœ°ç‚¹" 
            value="{{location}}"
            bindinput="onLocationChange"
            maxlength="50"
          />
        </view>

        <!-- æ˜†è™«è¾“å…¥ -->
        <view class="input-section">
          <text class="input-label">æ˜†è™«</text>
          <input 
            class="form-input" 
            placeholder="è¯·è¾“å…¥æ˜†è™«åç§°" 
            value="{{insectName}}"
            bindinput="onInsectNameChange"
            maxlength="20"
          />
        </view>

        <!-- å†…å®¹è¾“å…¥ -->
        <view class="content-section">
          <text class="input-label">åˆ†äº«ä½ çš„è§‚å¯Ÿå‘ç°</text>
          <textarea 
            class="content-input" 
            placeholder="åˆ†äº«ä½ çš„è§‚å¯Ÿå‘ç°..." 
            value="{{content}}"
            bindinput="onContentChange"
            maxlength="500"
          ></textarea>
          <text class="char-count">{{content.length}}/500</text>
        </view>

        <!-- å‘å¸ƒæŒ‰é’® -->
        <button 
          class="publish-btn {{submitting ? 'loading' : ''}}" 
          bindtap="submitPost"
          disabled="{{submitting}}"
        >
          {{submitting ? 'å‘å¸ƒä¸­...' : 'å‘å¸ƒ'}}
        </button>
      </view>
    </view>
  </view>
</view>