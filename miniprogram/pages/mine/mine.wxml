<view class="container">
  <!-- 顶部用户信息区域：根据登录态显示不同状态 -->
  <view class="profile-card" style="{{profileCardStyle}}">
    <view class="profile-overlay {{profileBackgroundType === 'image' ? 'image-overlay' : ''}}"></view>
    <view class="profile-content">
      <view class="avatar-wrapper" bindtap="{{isLoggedIn ? 'changeAvatar' : 'login'}}">
        <image class="avatar" src="{{userInfo.avatar_url || 'cloud://cloud1-5g6ssvupb26437e4.636c-cloud1-5g6ssvupb26437e4-1382475723/image/tx1.jpg'}}" mode="aspectFill" />
        <view class="avatar-edit-icon">{{isLoggedIn ? '✏️' : '🔑'}}</view>
      </view>
      <text class="nickname editable" bindtap="changeNickname">{{userInfo.nickname || '未登录'}}</text>
      <text class="role-badge">{{isLoggedIn ? (userInfo.user_type === 'parent' ? '家长' : '儿童') : '访客'}}</text>
    </view>
    <view class="card-action" bindtap="{{isLoggedIn ? 'openBackgroundPicker' : 'login'}}">
      <text>{{isLoggedIn ? '修改名片' : '点击登录'}}</text>
    </view>
  </view>

  <!-- 身份切换区域 -->
  <view class="identity-switch-section" wx:if="{{isLoggedIn}}">
    <view class="section-title">身份切换</view>
    <view class="identity-icons">
      <view class="identity-icon-wrapper {{userInfo.user_type === 'child' ? 'active' : ''}}" bindtap="switchIdentity" data-type="child">
        <view class="identity-icon child-icon">
          <text class="icon-emoji">👶</text>
        </view>
        <text class="identity-label">儿童</text>
      </view>
      <view class="identity-icon-wrapper {{userInfo.user_type === 'parent' ? 'active' : ''}}" bindtap="switchIdentity" data-type="parent">
        <view class="identity-icon parent-icon">
          <text class="icon-emoji">👨‍👩</text>
        </view>
        <text class="identity-label">家长</text>
      </view>
    </view>
  </view>

  <!-- 浏览记录 -->
  <view class="browse-history-section">
    <view class="section-header">
      <text class="section-title">浏览记录</text>
      <text class="section-subtitle">{{isLoggedIn ? (userInfo.user_type === 'parent' ? '家长' : '儿童') : '访客'}}身份下的浏览记录</text>
      <!-- 显示管理按钮（儿童和家长身份都显示） -->
      <view wx:if="{{isLoggedIn && (userInfo.user_type === 'child' || userInfo.user_type === 'parent')}}" class="manage-btn" bindtap="goToHistoryManage">
        <text>管理</text>
      </view>
    </view>
    <view class="browse-stats">
      <view class="browse-stat-item">
        <text class="stat-number">{{browseHistory.length}}</text>
        <text class="stat-label">已浏览昆虫</text>
      </view>
    </view>
    <view class="browse-list" wx:if="{{browseHistory.length > 0}}">
      <view wx:for="{{browseHistory}}" wx:key="insectId" class="browse-item" bindtap="goToInsectDetail" data-id="{{item.insectId}}">
        <image class="browse-image" src="{{item.image}}" mode="aspectFill" />
        <view class="browse-info">
          <text class="browse-name">{{item.name}}</text>
          <text class="browse-time">{{formatBrowseTime(item.browseTime)}}</text>
        </view>
      </view>
    </view>
    <view class="empty-browse" wx:else>
      <text class="empty-icon">🔍</text>
      <text class="empty-text">还没有浏览记录，快去探索虫虫图鉴吧！</text>
    </view>
  </view>

  <!-- 观看记录 -->
  <view class="browse-history-section">
    <view class="section-header">
      <text class="section-title">观看记录</text>
      <text class="section-subtitle">{{isLoggedIn ? (userInfo.user_type === 'parent' ? '家长' : '儿童') : '访客'}}身份下的观看记录</text>
      <!-- 儿童身份：显示管理按钮（即使没有记录也显示） -->
      <view wx:if="{{isLoggedIn && userInfo.user_type === 'child'}}" class="manage-btn" bindtap="goToWatchHistoryManage">
        <text>管理</text>
      </view>
    </view>
    <view class="browse-stats">
      <view class="browse-stat-item">
        <text class="stat-number">{{watchHistory.length}}</text>
        <text class="stat-label">已观看视频</text>
      </view>
    </view>
    <view class="browse-list" wx:if="{{watchHistory.length > 0}}">
      <view wx:for="{{watchHistory}}" wx:key="videoId" class="browse-item" bindtap="goToVideoDetail" data-id="{{item.videoId}}">
        <image class="browse-image" src="{{item.thumbnail}}" mode="aspectFill" />
        <view class="browse-info">
          <text class="browse-name">{{item.title}}</text>
          <text class="browse-time">{{formatWatchTime(item.watchTime)}}</text>
        </view>
      </view>
    </view>
    <view class="empty-browse" wx:else>
      <text class="empty-icon">🎬</text>
      <text class="empty-text">还没有观看记录，快去虫虫小剧场看看吧！</text>
    </view>
  </view>

  <!-- 功能菜单，随身份切换加入淡入动画 -->
  <view class="menu-section {{roleSwitching ? 'menu-fade' : ''}}">
    <!-- 儿童身份功能 -->
    <block wx:if="{{isLoggedIn && userInfo.user_type === 'child'}}">
      <view class="menu-item" bindtap="goToCategory">
        <text class="menu-icon">📖</text>
        <view class="menu-content">
          <text class="menu-text">浏览虫虫图鉴</text>
          <text class="menu-desc">探索昆虫世界</text>
        </view>
        <text class="menu-arrow">></text>
      </view>
      <view class="menu-item" bindtap="goToGame">
        <text class="menu-icon">🎮</text>
        <view class="menu-content">
          <text class="menu-text">玩小游戏</text>
          <text class="menu-desc">益害判官、虫虫拼图</text>
        </view>
        <text class="menu-arrow">></text>
      </view>
      <view class="menu-item" bindtap="goToTheater">
        <text class="menu-icon">🎬</text>
        <view class="menu-content">
          <text class="menu-text">观看虫虫小剧场</text>
          <text class="menu-desc">精彩视频内容</text>
        </view>
        <text class="menu-arrow">></text>
      </view>
      <view class="menu-item danger" bindtap="logout">
        <text class="menu-icon">🚪</text>
        <view class="menu-content">
          <text class="menu-text">退出登录</text>
          <text class="menu-desc">切换账号或安全退出</text>
        </view>
        <text class="menu-arrow">></text>
      </view>
    </block>

    <!-- 家长身份功能 -->
    <block wx:elif="{{isLoggedIn}}">
      <view class="menu-item" bindtap="goToKnowledgeBase">
        <text class="menu-icon">📚</text>
        <view class="menu-content">
          <text class="menu-text">科普知识库</text>
          <text class="menu-desc">丰富的昆虫知识</text>
        </view>
        <text class="menu-arrow">></text>
      </view>
      <view class="menu-item danger" bindtap="logout">
        <text class="menu-icon">🚪</text>
        <view class="menu-content">
          <text class="menu-text">退出登录</text>
          <text class="menu-desc">切换账号或安全退出</text>
        </view>
        <text class="menu-arrow">></text>
      </view>
    </block>

    <!-- 未登录提示 -->
    <block wx:else>
      <view class="menu-item" bindtap="login">
        <text class="menu-icon">🔑</text>
        <view class="menu-content">
          <text class="menu-text">登录后解锁全部功能</text>
          <text class="menu-desc">同步资料、记录与社区</text>
        </view>
        <text class="menu-arrow">></text>
      </view>
    </block>
  </view>

  <!-- 背景名片选择器 -->
  <view class="background-picker-mask {{showBackgroundPicker ? 'show' : ''}}" bindtap="closeBackgroundPicker">
    <view class="background-picker" catchtap="stopPropagation">
      <view class="picker-title">选择名片背景</view>
      <view class="picker-tabs">
        <view class="picker-tab {{currentTab === 'color' ? 'active' : ''}}" bindtap="switchTab" data-tab="color">颜色</view>
        <view class="picker-tab {{currentTab === 'image' ? 'active' : ''}}" bindtap="switchTab" data-tab="image">图片</view>
      </view>
      <!-- 颜色选择 -->
      <view class="picker-grid" wx:if="{{currentTab === 'color'}}">
        <view class="picker-item color-item {{profileBackground === item && profileBackgroundType === 'color' ? 'selected' : ''}}" wx:for="{{backgroundColorOptions}}" wx:key="index" data-value="{{item}}" data-type="color" bindtap="selectBackground">
          <view class="color-preview" style="background: {{item}};"></view>
          <view class="picker-check" wx:if="{{profileBackground === item && profileBackgroundType === 'color'}}">✓</view>
        </view>
      </view>
      <!-- 图片选择 -->
      <view class="picker-grid" wx:if="{{currentTab === 'image'}}">
        <view class="picker-item {{profileBackground === item && profileBackgroundType === 'image' ? 'selected' : ''}}" wx:for="{{backgroundImageOptions}}" wx:key="index" data-value="{{item}}" data-type="image" bindtap="selectBackground">
          <image src="{{item}}" mode="aspectFill"></image>
          <view class="picker-check" wx:if="{{profileBackground === item && profileBackgroundType === 'image'}}">✓</view>
        </view>
      </view>
      <view class="picker-actions">
        <button class="picker-btn" bindtap="uploadBackground" wx:if="{{currentTab === 'image'}}">上传照片</button>
        <button class="picker-btn secondary" bindtap="useRandomBackground" wx:if="{{currentTab === 'color'}}">随机颜色</button>
      </view>
      <button class="picker-close" bindtap="closeBackgroundPicker">完成</button>
    </view>
  </view>

  <!-- 头像选择器 -->
  <view class="avatar-picker-mask {{showAvatarPicker ? 'show' : ''}}" bindtap="closeAvatarPicker">
    <view class="avatar-picker" catchtap="stopPropagation">
      <view class="picker-title">选择头像</view>
      <view class="picker-grid avatar-grid">
        <view class="picker-item avatar-item {{userInfo.avatar_url === item ? 'selected' : ''}}" wx:for="{{avatarOptions}}" wx:key="item" data-url="{{item}}" bindtap="selectAvatar">
          <image src="{{item}}" mode="aspectFill"></image>
          <view class="picker-check" wx:if="{{userInfo.avatar_url === item}}">✓</view>
        </view>
      </view>
      <button class="picker-close" bindtap="closeAvatarPicker">取消</button>
    </view>
  </view>
</view>
